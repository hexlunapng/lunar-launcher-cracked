const{ipcRenderer:ipcRenderer}=require("electron");let currentUser=null,currentTab="home";const builds=[],runningGames=new Map;let isPackaged=!1,currentItemShop=null,currentLeaderboard=null,verificationStep=1,pendingUserData=null;const assetMap={logo:"logo.png","logo-large":"logo-large.png","luxor-logo":"LuxorNewLogoV1.png",vbucks:"vbucks-icon.png",hype:"hype.png",level:"level-icon.png",crown:"crown-icon.png","user-avatar":"user-avatar.png","news-banner":"news-banner.jpg","treasure-hunt":"treasure-hunt.jpg"};async function getImagePath(e){try{const t=assetMap[e]||e,n=await ipcRenderer.invoke("get-asset-path",t);return n.success?`file://${n.path.replace(/\\/g,"/")}`:(console.warn(`Asset not found: ${t}`),null)}catch(e){return console.error("Error getting image path:",e),null}}async function loadImageWithFallback(e,t,n){if(!e)return;const a=await getImagePath(t);a?(e.src=a,e.style.display="block",e.onload=()=>{console.log(` Loaded image: ${t}`),n&&(n.style.display="none")},e.onerror=()=>{console.warn(` Failed to load image: ${t}`),e.style.display="none",n&&(n.style.display="flex")}):(e.style.display="none",n&&(n.style.display="flex"))}async function initializeApp(){isPackaged=await ipcRenderer.invoke("is-packaged"),console.log(" App is packaged:",isPackaged);const e=await ipcRenderer.invoke("get-all-assets");e.success&&(console.log(" Available assets:",e.assets),console.log(" Assets path:",e.path)),setTimeout(()=>{document.body.removeAttribute("data-loading"),document.body.classList.remove("app-loading")},500),setupNavigation(),setupSettingsNavigation(),setupNewsModal(),loadBuilds(),setupWindowControls(),setupEventListeners(),setupAnimations(),createFloatingBackground(),loadSavedCredentials(),currentUser||setupDiscordAuth(),await loadAllLauncherAssets()}function setupDiscordAuth(){ipcRenderer.on("discord-token-received",(e,{token:t,username:n})=>{console.log("üîó Discord token received:",{token:t.substring(0,10)+"...",username:n}),handleDiscordToken(t,n)});const e=document.getElementById("websiteBtn"),t=document.getElementById("discordHelpBtn"),n=document.getElementById("confirmLoginBtn"),a=document.getElementById("cancelLoginBtn");e&&e.addEventListener("click",openWebsite),t&&t.addEventListener("click",openDiscordHelp),n&&n.addEventListener("click",confirmDiscordLogin),a&&a.addEventListener("click",cancelDiscordLogin);const r=document.getElementById("verificationMinimizeApp"),s=document.getElementById("verificationCloseApp");r&&r.addEventListener("click",()=>{ipcRenderer.send("minimize-app")}),s&&s.addEventListener("click",()=>{ipcRenderer.send("close-app")})}async function handleDiscordToken(e,t){console.log("üîÑ Processing Discord token..."),showVerificationScreen(),await startVerificationProcess(e,t)}function showVerificationScreen(){const e=document.getElementById("loginScreen"),t=document.getElementById("verificationScreen");e&&t&&(e.style.opacity="0",e.style.transform="scale(0.95)",setTimeout(()=>{e.classList.add("hidden"),t.classList.remove("hidden"),t.style.opacity="1",t.style.transform="scale(1)"},500))}async function startVerificationProcess(e,t){updateVerificationStatus("Connecting to authentication server...");try{await new Promise(e=>setTimeout(e,2e3)),updateVerificationStatus("Verifying Discord token..."),await new Promise(e=>setTimeout(e,1500));const n=await ipcRenderer.invoke("verify-discord-token",{token:e});if(!n.success)throw new Error(n.error||"Verification failed");updateVerificationStatus("Authentication successful!"),await new Promise(e=>setTimeout(e,1e3)),pendingUserData={...n.data,username:n.data.username||t,discordUsername:n.data.discordUsername||t,avatar:n.data.avatar},showVerificationStep2()}catch(e){console.error("‚ùå Verification failed:",e),showVerificationError(e.message)}}function updateVerificationStatus(e){const t=document.getElementById("verificationStatus");t&&(t.innerHTML=`<p>${e}</p>`)}function showVerificationStep2(){const e=document.getElementById("verificationStep1"),t=document.getElementById("verificationStep2");if(e&&t&&pendingUserData){const n=document.querySelectorAll(".step-number"),a=document.querySelectorAll(".step-line");n.length>=2&&(n[0].classList.add("completed"),n[0].innerHTML="‚úì",n[1].classList.add("active"),n[1].classList.remove("inactive")),a.length>=1&&a[0].classList.add("completed"),e.style.opacity="0",e.style.transform="translateY(-20px)",setTimeout(()=>{e.classList.remove("active"),t.classList.add("active"),t.style.opacity="1",t.style.transform="translateY(0)",updateUserPreview()},300)}}function updateUserPreview(){if(!pendingUserData)return;const e=document.getElementById("userNamePreview"),t=document.getElementById("userDiscordPreview"),n=document.getElementById("userAvatarPreview");if(e&&(e.textContent=pendingUserData.username||"Discord User"),t&&(t.textContent=pendingUserData.discordUsername||"Discord User"),n&&pendingUserData.avatar){const e=`https://cdn.discordapp.com/avatars/${pendingUserData.discordId}/${pendingUserData.avatar}.png?size=128`;n.src=e,n.onerror=()=>{n.src="Assets/user-avatar.png"}}}function playTrailer(){return new Promise(e=>{const t=document.createElement("video");t.src="Assets/trailer.mp4",t.autoplay=!0,t.controls=!1,t.disablePictureInPicture=!0,t.playsInline=!0,t.loop=!1,t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.objectFit="cover",t.style.zIndex="9999",t.style.background="black",document.body.appendChild(t),t.addEventListener("ended",()=>{t.pause(),t.currentTime=0,document.body.removeChild(t),e()}),t.addEventListener("pause",()=>{t.ended||t.play()})})}async function confirmDiscordLogin(){if(pendingUserData)try{currentUser={...pendingUserData,email:`${pendingUserData.username}@discord.local`,password:`discord_${pendingUserData.accountId}`};updateStatsDisplay(await fetchUserStats(currentUser.username)),document.getElementById("userName").textContent=currentUser.username,document.getElementById("settingsUserName").textContent=currentUser.username;const e=document.querySelector(".user-avatar-large img");if(e&&currentUser.avatar){const t=`https://cdn.discordapp.com/avatars/${currentUser.discordId}/${currentUser.avatar}.png?size=128`;e.src=t,e.onerror=()=>{e.src="Assets/user-avatar.png"}}localStorage.setItem("lunar-credentials",JSON.stringify({discordAuth:!0,username:currentUser.username,displayName:currentUser.username,accountId:currentUser.accountId,discordId:currentUser.discordId,avatar:currentUser.avatar}));const t=await ipcRenderer.invoke("is-trailer");console.log("Trailer flag:",t),!0===t&&(await playTrailer(),await ipcRenderer.invoke("set-trailer")),setTimeout(()=>{const e=document.getElementById("verificationScreen"),t=document.getElementById("mainLauncher");e&&t&&(e.style.opacity="0",e.style.transform="scale(0.95)",setTimeout(()=>{e.classList.add("hidden"),t.classList.remove("hidden"),t.style.opacity="1",t.style.transform="scale(1)"},500))},1e3)}catch(e){console.error("Login confirmation error:",e),showToast("Failed to complete login","error")}else showToast("No user data available","error")}function cancelDiscordLogin(){pendingUserData=null;const e=document.getElementById("verificationScreen"),t=document.getElementById("loginScreen");e&&t&&(e.style.opacity="0",e.style.transform="scale(0.95)",setTimeout(()=>{e.classList.add("hidden"),t.classList.remove("hidden"),t.style.opacity="1",t.style.transform="scale(1)",resetVerificationSteps()},500)),showToast("Login cancelled","info")}function resetVerificationSteps(){const e=document.getElementById("verificationStep1"),t=document.getElementById("verificationStep2"),n=document.querySelectorAll(".step-number"),a=document.querySelectorAll(".step-line");e&&(e.classList.add("active"),e.style.opacity="1",e.style.transform="translateY(0)"),t&&(t.classList.remove("active"),t.style.opacity="0",t.style.transform="translateY(20px)"),n.length>=2&&(n[0].classList.remove("completed"),n[0].innerHTML="1",n[1].classList.remove("active"),n[1].classList.add("inactive")),a.length>=1&&a[0].classList.remove("completed"),updateVerificationStatus("Connecting to authentication server...")}function showVerificationError(e){updateVerificationStatus(`‚ùå ${e}`);const t=document.getElementById("verificationStatus");t&&(t.innerHTML=`\n            <p>‚ùå ${e}</p>\n            <button class="verification-btn primary" onclick="retryVerification()" style="margin-top: 16px;">\n                <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">\n                    <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>\n                </svg>\n                Retry\n            </button>\n        `)}function retryVerification(){cancelDiscordLogin()}async function openWebsite(){try{(await ipcRenderer.invoke("open-website")).success||showToast("Failed to open website","error")}catch(e){console.error("Error opening website:",e),showToast("Failed to open website","error")}}async function launchBuild(e){if(currentUser){showToast(`Launching ${e.name}...`,"info");try{const t=await ipcRenderer.invoke("launch-fortnite-with-dll",{buildPath:e.path,userData:currentUser});if(!t.success)throw new Error(t.error||"Launch failed");{runningGames.set(e.id,{processId:t.processId,buildName:e.name,startTime:Date.now()}),renderBuilds(),showToast(`Successfully launched ${e.name}`,"success");const n=()=>{runningGames.delete(e.id),renderBuilds(),showToast(`${e.name} has been closed`,"info"),ipcRenderer.removeListener(`game-process-exit-${e.id}`,n)};ipcRenderer.on(`game-process-exit-${e.id}`,n)}}catch(e){console.error("Launch error:",e),showToast(`Failed to launch: ${e.message}`,"error")}}else showToast("Please complete Discord authentication first","error")}function loadSavedCredentials(){try{const e=localStorage.getItem("lunar-credentials");if(e){const t=JSON.parse(e);t.discordAuth&&t.username&&autoLoginDiscord(t)}else ipcRenderer.invoke("is-accounts")}catch(e){console.error("Error loading saved credentials:",e)}}async function autoLoginDiscord(e){try{currentUser={username:e.username,displayName:e.displayName||e.username,accountId:e.accountId,discordId:e.discordId,avatar:e.avatar,email:`${e.username}@discord.local`,password:`discord_${e.accountId}`};const t=await fetch(`https://api.backend-services-lunar.xyz/account/api/get-email?username=${encodeURIComponent(currentUser.username)}`);if((await t.json()).x12x_3){updateStatsDisplay(await fetchUserStats(currentUser.username)),document.getElementById("userName").textContent=currentUser.username,document.getElementById("settingsUserName").textContent=currentUser.username;const e=document.querySelector(".user-avatar-large img");if(e&&currentUser.avatar&&currentUser.discordId){const t=`https://cdn.discordapp.com/avatars/${currentUser.discordId}/${currentUser.avatar}.png?size=128`;e.src=t,e.onerror=()=>{e.src="Assets/user-avatar.png"}}firsttime=ipcRenderer.invoke("is-trailer"),firsttime?(await ipcRenderer.invoke("is-trailer"),showMainLauncher()):(playTrailerThenShowMain(),await ipcRenderer.invoke("is-trailer"))}else localStorage.removeItem("lunar-credentials")}catch(e){console.error("Auto login failed:",e),localStorage.removeItem("lunar-credentials")}}function showMainLauncher(){setTimeout(()=>{document.getElementById("loginScreen").style.opacity="0",document.getElementById("loginScreen").style.transform="scale(0.95)",setTimeout(()=>{document.getElementById("loginScreen").classList.add("hidden"),document.getElementById("mainLauncher").classList.remove("hidden"),document.getElementById("mainLauncher").style.opacity="1",document.getElementById("mainLauncher").style.transform="scale(1)"},500)},1e3)}function playTrailerThenShowMain(){const e=document.createElement("video");e.src="Assets/trailer.mp4",e.autoplay=!0,e.controls=!1,e.disablePictureInPicture=!0,e.playsInline=!0,e.loop=!1,e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.objectFit="cover",e.style.zIndex="9999",e.style.background="black",document.body.appendChild(e),e.addEventListener("ended",()=>{e.pause(),e.currentTime=0,document.body.removeChild(e),showMainLauncher()}),e.addEventListener("pause",()=>{e.ended||e.play()})}function handleLogout(){runningGames.forEach(async(e,t)=>{try{await ipcRenderer.invoke("close-game-process",{buildId:t,processId:e.processId})}catch(e){console.error("Error closing game on logout:",e)}}),runningGames.clear(),currentUser=null,currentItemShop=null,currentLeaderboard=null,pendingUserData=null,localStorage.removeItem("lunar-credentials"),document.getElementById("mainLauncher").style.opacity="0",document.getElementById("mainLauncher").style.transform="scale(0.95)",setTimeout(()=>{document.getElementById("mainLauncher").classList.add("hidden"),document.getElementById("loginScreen").classList.remove("hidden"),document.getElementById("loginScreen").style.opacity="1",document.getElementById("loginScreen").style.transform="scale(1)",resetVerificationSteps()},500),showToast("Logged out successfully","success")}function showToast(e,t="info"){const n=document.getElementById("toast"),a=document.getElementById("toastMessage");if(n&&a){n.classList.remove("toast-info","toast-success","toast-error","toast-warning"),n.classList.add(`toast-${t}`),a.textContent=e,n.classList.add("show");setTimeout(()=>{n.classList.remove("show")},"error"===t?5e3:3e3)}else console.log(`Toast (${t}):`,e)}async function loadAllLauncherAssets(){console.log("üîÑ Loading launcher assets...");const e=document.querySelectorAll(".main-logo, .launcher-logo, [data-logo]");for(const t of e)await loadImageWithFallback(t,"luxor-logo");const t=document.querySelectorAll('.vbucks-icon, [data-asset="vbucks"]');for(const e of t)await loadImageWithFallback(e,"vbucks");const n=document.querySelectorAll('.hype-icon, [data-asset="hype"]');for(const e of n)await loadImageWithFallback(e,"hype");const a=document.querySelectorAll('.level-icon, [data-asset="level"]');for(const e of a)await loadImageWithFallback(e,"level");console.log(" All launcher assets loaded!")}function createFloatingBackground(){const e=document.createElement("div");e.className="floating-background";for(let t=1;t<=10;t++){const n=document.createElement("div");n.className=`floating-circle circle-${t}`,e.appendChild(n)}document.body.appendChild(e)}function setupEventListeners(){const e=document.getElementById("importBtn");e&&e.addEventListener("click",handleImportBuild);const t=document.getElementById("logoutBtn");t&&t.addEventListener("click",handleLogout);const n=document.getElementById("trailerBtn");n&&n.addEventListener("click",playTrailerThenShowMain);const a=document.getElementById("helpBtn");a&&a.addEventListener("click",openDiscordHelp);const r=document.getElementById("downloadFortniteBtn"),s=document.getElementById("downloadClientBtn");r&&r.addEventListener("click",downloadFortnite),s&&s.addEventListener("click",downloadFortnite);const o=document.getElementById("refreshShopBtn");o&&o.addEventListener("click",handleRefreshItemShop);const i=document.getElementById("refreshLeaderboardBtn");i&&i.addEventListener("click",handleRefreshLeaderboard);const c=document.getElementById("retryItemShopBtn");c&&c.addEventListener("click",loadItemShop);const d=document.getElementById("retryLeaderboardBtn");d&&d.addEventListener("click",loadLeaderboard),addRippleEffect()}function setupSettingsNavigation(){const e=document.querySelectorAll(".settings-tab-enhanced");e.forEach(t=>{t.addEventListener("click",t=>{const n=t.currentTarget.dataset.tab;n&&(switchSettingsTab(n),e.forEach(e=>e.classList.remove("active")),t.currentTarget.classList.add("active"))})})}function switchSettingsTab(e){document.querySelectorAll(".settings-panel-enhanced").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.transform="translateY(20px)"}),setTimeout(()=>{const t=document.getElementById(`${e}Settings`);t&&(t.classList.add("active"),t.style.opacity="1",t.style.transform="translateY(0)")},200)}function setupNewsModal(){const e=document.getElementById("newsCard"),t=document.getElementById("newsModal"),n=document.getElementById("newsModalClose"),a=document.getElementById("newsModalBackdrop");e&&e.addEventListener("click",openNewsModal),n&&n.addEventListener("click",closeNewsModal),a&&a.addEventListener("click",closeNewsModal),document.addEventListener("keydown",e=>{"Escape"===e.key&&t&&!t.classList.contains("hidden")&&closeNewsModal()})}function openNewsModal(){const e=document.getElementById("newsModal");e&&(e.classList.remove("hidden"),document.body.style.overflow="hidden",setTimeout(()=>{e.style.opacity="1"},10))}function closeNewsModal(){const e=document.getElementById("newsModal");e&&(e.style.opacity="0",document.body.style.overflow="",setTimeout(()=>{e.classList.add("hidden")},300))}async function loadItemShop(){const e=document.getElementById("itemshopLoading"),t=document.getElementById("itemshopError"),n=document.getElementById("itemshopItems"),a=document.getElementById("itemshopErrorMessage");e?.classList.remove("hidden"),t?.classList.add("hidden"),n?.classList.add("hidden");try{const t=await fetch("https://api.backend-services-lunar.xyz/api/launcher/itemshop"),a=await t.json();if(console.log("ITEM SHOP RESULT:",a),!a.success)throw new Error(a.error||"Failed to load item shop");renderItemShop(a.data),e?.classList.add("hidden"),n?.classList.remove("hidden")}catch(n){e?.classList.add("hidden"),t?.classList.remove("hidden"),a&&(a.textContent=n.message),console.error("Item shop load failed:",n)}}function renderItemShop(e){const t=document.getElementById("featuredItems"),n=document.getElementById("dailyItems");if(t&&n){t.innerHTML="",n.innerHTML="";for(const t in e.daily){const a=e.daily[t];a.items.forEach(e=>{const t={name:e.name,image:e.image,rarity:e.rarity,price:a.price};n.appendChild(createFortniteShopItem(t))})}for(const n in e.featured){const a=e.featured[n];a.items.forEach(e=>{const n={name:e.name,image:e.image,rarity:e.rarity,price:a.price};t.appendChild(createFortniteShopItem(n))})}}}function testRenderItemShop(){const e=document.getElementById("featuredItems"),t=document.getElementById("dailyItems");if(!e||!t)return;e.innerHTML="",t.innerHTML="";e.appendChild(createFortniteShopItem({name:"Skin Test Featured",image:"https://via.placeholder.com/200x200?text=Featured",rarity:"Rare",price:1500})),e.appendChild(createFortniteShopItem({name:"Skin Test Featured",image:"https://via.placeholder.com/200x200?text=Featured",rarity:"MARVEL SERIES",price:1500})),e.appendChild(createFortniteShopItem({name:"Skin Test Featured",image:"https://via.placeholder.com/200x200?text=Featured",rarity:"Epic",price:1500})),e.appendChild(createFortniteShopItem({name:"Skin Test Featured",image:"https://via.placeholder.com/200x200?text=Featured",rarity:"Legendary",price:1500})),t.appendChild(createFortniteShopItem({name:"Skin Test Daily",image:"https://via.placeholder.com/200x200?text=Daily",rarity:"common",price:1200})),t.appendChild(createFortniteShopItem({name:"Skin Test Daily",image:"https://via.placeholder.com/200x200?text=Daily",rarity:"DC SERIES",price:1200})),t.appendChild(createFortniteShopItem({name:"Skin Test Daily",image:"https://via.placeholder.com/200x200?text=Daily",rarity:"Epic",price:1200})),t.appendChild(createFortniteShopItem({name:"Skin Test Daily",image:"https://via.placeholder.com/200x200?text=Daily",rarity:"Legendary",price:1200})),t.appendChild(createFortniteShopItem({name:"Skin Test Daily",image:"https://via.placeholder.com/200x200?text=Daily",rarity:"Uncommon",price:1200})),t.appendChild(createFortniteShopItem({name:"Skin Test Daily",image:"https://via.placeholder.com/200x200?text=Daily",rarity:"Uncommon",price:1200}))}function createFortniteShopItem(e){const t=document.createElement("div");t.className="shop-item-enhanced";const n=e.rarity?"rarity-"+e.rarity.toLowerCase().replace(/\s+/g,""):"rarity-common";t.className=`shop-item-enhanced ${n}`;const a=document.createElement("div");a.className="shop-item-image";const r=document.createElement("img");r.src=e.image,r.alt=e.name,r.loading="lazy",a.appendChild(r);const s=document.createElement("div");s.className="shop-item-overlay",a.appendChild(s);const o=document.createElement("div");o.className="shop-item-info";const i=document.createElement("div");i.className="shop-item-name",i.textContent=e.name;const c=document.createElement("div");c.className="shop-item-price";const d=document.createElement("span");d.className="vbucks-icon-small";const l=document.createElement("span");return l.textContent=e.price,c.appendChild(d),c.appendChild(l),o.appendChild(i),o.appendChild(c),t.appendChild(a),t.appendChild(o),t}async function loadLeaderboard(){const e=document.getElementById("leaderboardLoading"),t=document.getElementById("leaderboardError"),n=document.getElementById("leaderboardData");e&&e.classList.remove("hidden"),t&&t.classList.add("hidden"),n&&n.classList.add("hidden");try{const t=await ipcRenderer.invoke("get-leaderboard");if(!t.success)throw new Error(t.error||"Failed to load leaderboard");currentLeaderboard=t.data,renderLeaderboard(t.data),e&&e.classList.add("hidden"),n&&n.classList.remove("hidden")}catch(n){if(console.error("Leaderboard error:",n),e&&e.classList.add("hidden"),t){t.classList.remove("hidden");const e=document.getElementById("leaderboardErrorMessage");e&&(e.textContent=n.message)}}}function renderLeaderboard(e){const t=document.getElementById("leaderboardList");t&&(t.innerHTML="",e.players&&Array.isArray(e.players)&&e.players.forEach((e,n)=>{const a=createLeaderboardEntry(e,n+1);t.appendChild(a)}))}function createLeaderboardEntry(e,t){const n=document.createElement("div");n.className="leaderboard-entry",t<=3&&n.classList.add(`rank-${t}`);const a=currentUser&&e.username===currentUser.username;return a&&n.classList.add("current-user"),n.innerHTML=`\n        <div class="entry-rank">\n            ${t<=3?getRankIcon(t):`#${t}`}\n        </div>\n        <div class="entry-player">\n            <div class="player-avatar">\n                <img src="Assets/user-avatar.png" alt="Avatar">\n            </div>\n            <div class="player-info">\n                <span class="player-name">${e.username||"Unknown"}</span>\n                ${a?'<span class="you-indicator">You</span>':""}\n            </div>\n        </div>\n        <div class="entry-wins">\n            <span class="stat-value">${e.wins||0}</span>\n        </div>\n        <div class="entry-eliminations">\n            <span class="stat-value">${e.eliminations||0}</span>\n        </div>\n        <div class="entry-hype">\n            <span class="stat-value">${(e.hype||0).toLocaleString()}</span>\n        </div>\n    `,n}function getRankIcon(e){return`<span class="rank-icon">${{1:"ü•á",2:"ü•à",3:"ü•â"}[e]||`#${e}`}</span>`}async function handleRefreshItemShop(){const e=document.getElementById("refreshShopBtn"),t=document.getElementById("refreshText"),n=document.getElementById("refreshSpinner");e.disabled=!0,t.style.opacity="0",n.classList.remove("hidden");try{await loadItemShop(),showToast("Item shop refreshed!","success")}catch(e){showToast("Failed to refresh item shop","error")}finally{e.disabled=!1,t.style.opacity="1",n.classList.add("hidden")}}async function handleRefreshLeaderboard(){const e=document.getElementById("refreshLeaderboardBtn"),t=document.getElementById("refreshLeaderboardText"),n=document.getElementById("refreshLeaderboardSpinner");e.disabled=!0,t.style.opacity="0",n.classList.remove("hidden");try{await loadLeaderboard(),showToast("Leaderboard refreshed!","success")}catch(e){showToast("Failed to refresh leaderboard","error")}finally{e.disabled=!1,t.style.opacity="1",n.classList.add("hidden")}}function setupAnimations(){const e=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(e.target.style.animationPlayState="running")})},{threshold:.1,rootMargin:"0px 0px -50px 0px"});document.querySelectorAll(".stat-card, .news-card-enhanced, .game-card-enhanced").forEach(t=>{t.style.animationPlayState="paused",e.observe(t)})}function setupNavigation(){const e=document.querySelectorAll(".nav-item");e.forEach(t=>{t.addEventListener("click",t=>{const n=t.currentTarget.dataset.tab;if(n){switchTab(n),e.forEach(e=>{e.classList.remove("active");const t=e.querySelector(".nav-indicator");t&&(t.style.transform="scale(0)")}),t.currentTarget.classList.add("active");const a=t.currentTarget.querySelector(".nav-indicator");a&&setTimeout(()=>{a.style.transform="scale(1)"},100)}})})}function switchTab(e){document.querySelectorAll(".tab-content").forEach(e=>{e.classList.remove("active"),e.style.opacity="0",e.style.transform="translateY(20px)"}),setTimeout(()=>{const t=document.getElementById(`${e}Tab`);t&&(t.classList.add("active"),t.style.opacity="1",t.style.transform="translateY(0)","itemshop"!==e||currentItemShop?"leaderboard"!==e||currentLeaderboard||loadLeaderboard():loadItemShop()),currentTab=e},200)}async function fetchUserStats(e){try{const t=await ipcRenderer.invoke("get-user-stats",{username:e});if(t.success)return{vbucks:t.data.vbucks||0,hype:t.data.hype||0,level:t.data.level||1};throw new Error(t.error||"Failed to fetch stats")}catch(e){return console.error("Error fetching stats:",e),{vbucks:0,hype:0,level:1}}}function updateStatsDisplay(e){const t=document.getElementById("vbucksDisplay"),n=document.getElementById("hypeDisplay"),a=document.getElementById("levelDisplay");t&&(t.textContent=e.vbucks.toLocaleString()),n&&(n.textContent=e.hype.toLocaleString()),a&&(a.textContent=e.level.toLocaleString());[t,n,a].forEach(e=>{e&&(e.style.animation="pulse 0.5s ease-in-out",setTimeout(()=>{e.style.animation=""},500))})}async function handleImportBuild(){if(!currentUser)return void showToast("Please complete Discord authentication first","error");const e=document.getElementById("importBtn"),t=document.getElementById("importText"),n=document.getElementById("importSpinner");e.disabled=!0,t.textContent="Importing...",n.classList.remove("hidden");try{const e=await ipcRenderer.invoke("select-fortnite-build");if(e.success){const t=e.filePaths[0],n=t.split(/[\\/]/).pop(),a=e.splashImage;builds.push({id:Date.now().toString(),name:n,path:t,version:"Season 5",chapter:"Chapter 2",added:(new Date).toISOString(),splashImage:a}),saveBuildsList(),renderBuilds(),showToast(`Successfully imported ${n}`,"success")}}catch(e){showToast("Failed to import build","error"),console.error("Import error:",e)}finally{e.disabled=!1,t.textContent="Add Build",n.classList.add("hidden")}}function loadBuilds(){try{const e=localStorage.getItem("lunar-builds");if(e){const t=JSON.parse(e);builds.push(...t),renderBuilds()}}catch(e){console.error("Error loading builds:",e)}}function saveBuildsList(){try{localStorage.setItem("lunar-builds",JSON.stringify(builds))}catch(e){console.error("Error saving builds:",e)}}function renderBuilds(){const e=document.getElementById("libraryEmpty"),t=document.getElementById("libraryGames");if(0===builds.length)return e&&e.classList.remove("hidden"),void(t&&t.classList.add("hidden"));e&&e.classList.add("hidden"),t&&(t.classList.remove("hidden"),t.innerHTML="",builds.forEach((e,n)=>{const a=document.createElement("div");a.className="build-card",a.dataset.id=e.id;const r=runningGames.has(e.id);r?a.classList.add("game-running"):a.classList.remove("game-running"),a.innerHTML=`\n                <div class="build-image">\n                    ${e.splashImage?`<img src="file://${e.splashImage}" alt="Splash Image">`:'<div class="fortnite-character">üèùÔ∏è</div>'}\n                    \n                    \x3c!-- Hover overlay (Play button) --\x3e\n                    <div class="overlay overlay-hover">\n                        <div class="play-icon">‚ñ∂</div>\n                    </div>\n\n                     ${r&&a.classList.contains("game-running")?"":`<button class="delete-icon" onclick="removeBuild('${e.id}')" title="Remove Build">üóëÔ∏è</button>`}</div>\n\n                    \x3c!-- Loading overlay --\x3e\n                    <div class="overlay overlay-loading">\n                        <div class="loader"></div>\n                    </div>\n                </div>\n                <div class="build-info">\n                    <div class="build-version">${e.name}</div>\n                    <div class="build-chapter">${e.version} - ${e.chapter}</div>\n                </div>\n            `,a.addEventListener("click",t=>{t.target.closest(".delete-icon")||r||a.classList.contains("game-running")||(a.classList.add("game-running"),launchBuild(e))}),t.appendChild(a)}))}function setupWindowControls(){document.getElementById("minimizeApp").addEventListener("click",()=>{ipcRenderer.send("minimize-app")}),document.getElementById("closeApp").addEventListener("click",()=>{ipcRenderer.send("close-app")}),document.getElementById("loginMinimizeApp").addEventListener("click",()=>{ipcRenderer.send("minimize-app")}),document.getElementById("loginCloseApp").addEventListener("click",()=>{ipcRenderer.send("close-app")})}function addRippleEffect(){document.querySelectorAll(".login-button, .card-action-btn, .download-btn-enhanced, .empty-action-btn, .help-btn, .check-updates-btn-enhanced, .shop-item-buy-btn, .refresh-shop-btn-enhanced, .refresh-leaderboard-btn-enhanced, .verification-btn").forEach(e=>{e.addEventListener("click",t=>{const n=t.clientX-t.target.getBoundingClientRect().left,a=t.clientY-t.target.getBoundingClientRect().top,r=document.createElement("span");r.className="button-ripple",r.style.left=`${n}px`,r.style.top=`${a}px`,e.appendChild(r),setTimeout(()=>{r.remove()},600)})})}document.addEventListener("DOMContentLoaded",()=>{initializeApp()});const enhancedStyles=document.createElement("style");function removeBuild(e){const t=builds.findIndex(t=>t.id===e);-1!==t&&(builds.splice(t,1),saveBuildsList(),renderBuilds(),showToast("Build removed successfully","success"))}function openDiscordHelp(){if("undefined"!=typeof require){const{shell:e}=require("electron");e.openExternal("https://discord.gg/lunarfn")}else window.open("https://discord.gg/lunarfn","_blank")}function downloadFortnite(){if("undefined"!=typeof require){const{shell:e}=require("electron");e.openExternal("http://cdn.lunarfn.net/15.30.rar")}else window.open("http://cdn.lunarfn.net/15.30.rar","_blank")}async function loadServers(){try{const e=await fetch("https://api.backend-services-lunar.xyz/api/games/loadall"),t=await e.json();if("No games available."===t.error)return void clearAllServers();updateServerItems(t)}catch(e){console.error("Erreur lors de la r√©cup√©ration des serveurs :",e)}}function updateServerItems(e){const t=Object.keys(e);t.forEach(t=>{const n=e[t];currentServers[t]?updateServerItem(t,n):createServerItem(t,n)}),Object.keys(currentServers).forEach(e=>{t.includes(e)||removeServerItem(e)}),currentServers=e}function createServerItem(e,t){const n=document.createElement("div");n.classList.add("server-item"),n.dataset.id=e;const a=t.joined?"#f4a261":"#2ecc71";n.innerHTML=`\n        <div class="server-item-header">\n            <div>\n                <span class="server-status-dot" style="background-color: ${a};"></span>\n                <span class="server-status">${t.joined?"READY":"INGAME"}</span>\n                <span class="server-name"> ‚Ä¢ ${t.server}</span>\n            </div>\n            <span class="server-count">${t.player}/35</span>\n        </div>\n        <div class="server-details">\n            ${t.region} ‚Ä¢ <span class="uuid">${t.id}</span>\n        </div>\n        <div class="server-progress" style="width: ${t.player/35*100}%;"></div>\n    `,document.querySelector(".serversTab-content-enhanced").appendChild(n),requestAnimationFrame(()=>{n.classList.remove("removing"),n.offsetHeight,n.classList.add("server-item")})}function updateServerItem(e,t){const n=document.querySelector(`.server-item[data-id="${e}"]`);if(n){const e=n.querySelector(".server-status-dot"),a=n.querySelector(".server-status"),r=n.querySelector(".server-name"),s=n.querySelector(".server-count"),o=n.querySelector(".uuid"),i=n.querySelector(".server-progress"),c=t.joined?"#f4a261":"#2ecc71";e.style.backgroundColor=c,a.textContent=t.joined?"INGAME":"WAITING",r.textContent=` ‚Ä¢ ${t.server}`,s.textContent=`${t.player}/35`,o.textContent=t.id,i.style.width=t.player/35*100+"%"}}function removeServerItem(e){const t=document.querySelector(`.server-item[data-id="${e}"]`);t&&(requestAnimationFrame(()=>{t.classList.add("removing")}),t.addEventListener("animationend",()=>{t.remove()}))}function clearAllServers(){const e=document.querySelector(".serversTab-content-enhanced");e&&(e.innerHTML=""),currentServers={}}enhancedStyles.textContent="\n    .toast-info { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }\n    .toast-success { background: linear-gradient(135deg, #10b981, #059669); }\n    .toast-error { background: linear-gradient(135deg, #ef4444, #dc2626); }\n    .toast-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }\n    \n    @keyframes shake {\n        0%, 100% { transform: translateX(0); }\n        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }\n        20%, 40%, 60%, 80% { transform: translateX(5px); }\n    }\n    \n    @keyframes pulse {\n        0% { transform: scale(1); opacity: 0.7; }\n        50% { transform: scale(1.05); opacity: 1; }\n        100% { transform: scale(1); opacity: 1; }\n    }\n    \n    .build-card {\n        transition: all 0.3s ease-in-out;\n    }\n    \n    #newsModal {\n        transition: opacity 0.3s ease-in-out;\n        opacity: 0;\n    }\n    \n    #newsModal:not(.hidden) {\n        opacity: 1;\n    }\n",document.head.appendChild(enhancedStyles);let currentServers={};setInterval(loadServers,3e3),loadServers(),window.openDiscordHelp=openDiscordHelp,window.downloadFortnite=downloadFortnite,window.removeBuild=removeBuild,window.openNewsModal=openNewsModal,window.closeNewsModal=closeNewsModal,window.retryVerification=retryVerification;